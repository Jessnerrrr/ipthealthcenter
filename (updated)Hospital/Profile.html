<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Barangay Health Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        #main-header { position: fixed; top: 0; width: 100%; transition: top 0.3s ease-in-out; z-index: 50; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        body.modal-active { overflow: hidden; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 pt-[72px]">

    <header id="main-header" class="bg-white shadow-md">
        <nav class="w-full px-10 py-5 flex justify-between items-center">
            <a href="Homee.html" class="text-xl md:text-2xl font-bold text-teal-700 flex-shrink-0">Barangay Health Center</a>
            
            <div class="hidden lg:flex flex-grow justify-center gap-6 xl:gap-8 items-center">
                <a href="Homee.html" class="font-medium text-teal-600 border-b-2 border-teal-600 pb-1 transition duration-200">Home</a>
                <a href="about.html" class="font-medium text-gray-700 hover:text-teal-600 transition duration-200">About Us</a>
                <a href="services.html" class="font-medium text-gray-700 hover:text-teal-600 transition duration-200">Services</a>
                <a href="announcements.html" class="font-medium text-gray-700 hover:text-teal-600 transition duration-200">Announcements</a>
                <a href="contact.html" class="font-medium text-gray-700 hover:text-teal-600 transition duration-200">Contact Us</a>
                <a href="faqs.html" class="font-medium text-gray-700 hover:text-teal-600 transition duration-200">FAQs</a>
            </div>
            
            <div class="flex-shrink-0 flex gap-4 items-center">
                <button class="open-appointment-modal bg-gradient-to-r from-teal-600 to-teal-700 text-white px-5 py-2 rounded-full font-semibold hover:from-teal-700 hover:to-teal-600 transition duration-300 text-sm md:text-base shadow-md">
                    Book Now
                </button>

                <div class="relative hidden lg:block">
                    <button type="button" id="user-menu-button" class="flex items-center justify-center rounded-full bg-teal-100 p-1 hover:ring-2 hover:ring-teal-500 transition focus:outline-none">
                        <img id="header-profile-img" class="h-9 w-9 rounded-full object-cover" src="https://placehold.co/100x100/teal/white?text=User" alt="User Profile">
                    </button>
                    <div id="user-dropdown-menu" class="hidden absolute right-0 z-50 mt-2 w-56 origin-top-right rounded-md bg-white py-1 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none transform opacity-0 scale-95 transition ease-out duration-100">
                        <div class="px-4 py-3 border-b border-gray-100">
                            <p class="text-sm text-gray-500">Signed in as</p>
                            <p id="dropdown-email" class="text-sm font-bold text-gray-900 truncate">loading...</p>
                        </div>
                        <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-teal-50 hover:text-teal-700">My Profile</a>
                        <a href="my_appointments.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-teal-50 hover:text-teal-700">My Appointments</a>
                        <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-teal-50 hover:text-teal-700">Settings</a>
                        <div class="border-t border-gray-100 my-1"></div>
                        <a href="#" onclick="logoutUser()" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50">Sign out</a>
                    </div>
                </div>

                <button id="mobile-menu-toggle" class="lg:hidden text-gray-700 hover:text-teal-600 p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path id="menu-icon-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </nav>

        <div id="mobile-menu" class="lg:hidden hidden bg-white w-full shadow-lg absolute top-full left-0 z-40 border-t border-gray-200">
            <div class="bg-teal-50 p-4 flex items-center gap-3 border-b border-teal-100">
                <img id="mobile-profile-img" class="h-10 w-10 rounded-full object-cover border border-teal-200" src="https://placehold.co/100x100/teal/white?text=User" alt="User">
                <div>
                    <p id="mobile-name" class="text-sm font-bold text-gray-800">User</p>
                    <p id="mobile-email" class="text-xs text-gray-600">loading...</p>
                </div>
            </div>
            <div class="flex flex-col p-4 gap-2">
                <a href="Homee.html" class="block px-4 py-2 text-gray-700 hover:bg-teal-50 rounded-md font-medium">Home</a>
                <a href="profile.html" class="block px-4 py-2 text-gray-700 hover:bg-teal-50 rounded-md font-medium">My Profile</a>
                <a href="my_appointments.html" class="block px-4 py-2 text-gray-700 hover:bg-teal-50 rounded-md font-medium">Appointments</a>
                <a href="#" onclick="logoutUser()" class="block px-4 py-2 text-red-600 hover:bg-red-50 rounded-md font-medium">Sign Out</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-10 max-w-6xl">
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:p-8 mb-8 flex flex-col md:flex-row items-center md:items-start gap-6">
            <div class="flex-shrink-0">
                <img id="profile-display-img" class="h-28 w-28 md:h-32 md:w-32 rounded-full object-cover border-4 border-teal-50" src="https://placehold.co/150x150/teal/white?text=User" alt="Profile">
            </div>
            
            <div class="flex-grow text-center md:text-left">
                <h1 id="display-fullname" class="text-3xl font-bold text-gray-900">Juan Dela Cruz</h1>
                <p class="text-gray-500 font-medium">Resident ID: <span class="text-gray-700">BRGY-2025-089</span></p>
                <div class="flex flex-wrap justify-center md:justify-start gap-3 mt-4">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-teal-100 text-teal-800">Active Resident</span>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Senior Citizen (pending)</span>
                </div>
            </div>

            <div class="flex-shrink-0 mt-4 md:mt-0">
                <a href="settings.html" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none transition">
                    <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                    Edit Profile
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 space-y-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-100">
                        <h3 class="font-semibold text-gray-900">Personal Information</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-semibold tracking-wider">Contact</p>
                            <p id="display-email" class="text-sm font-medium text-gray-900 mt-1">juan.delacruz@email.com</p>
                            <p id="display-phone" class="text-sm font-medium text-gray-900">0917 123 4567</p>
                        </div>
                        <hr class="border-gray-100">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-semibold tracking-wider">Address</p>
                            <p id="display-address" class="text-sm font-medium text-gray-900 mt-1">Block 5, Lot 2, Mabuhay Street</p>
                        </div>
                        <hr class="border-gray-100">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-semibold tracking-wider">Basic Health Info</p>
                            <div class="grid grid-cols-2 gap-4 mt-2">
                                <div><span class="text-xs text-gray-500">Birthdate</span><p class="text-sm font-medium text-gray-900">Jan 15, 1980</p></div>
                                <div><span class="text-xs text-gray-500">Age</span><p class="text-sm font-medium text-gray-900">45 yrs old</p></div>
                                <div><span class="text-xs text-gray-500">Sex</span><p class="text-sm font-medium text-gray-900">Male</p></div>
                                <div><span class="text-xs text-gray-500">Blood Type</span><p class="text-sm font-medium text-gray-900">O+</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
                        <h3 class="font-semibold text-gray-900">Upcoming Appointments</h3>
                        <button class="open-appointment-modal text-sm text-teal-600 hover:text-teal-700 font-medium">Book New</button>
                    </div>
                    <div class="p-6">
                        <div class="flex flex-col sm:flex-row gap-4 p-4 border border-teal-100 bg-teal-50 rounded-lg items-start sm:items-center">
                            <div class="bg-white p-3 rounded-md shadow-sm text-center min-w-[80px]">
                                <span class="block text-xs font-bold text-gray-500 uppercase">DEC</span>
                                <span class="block text-2xl font-bold text-teal-600">30</span>
                            </div>
                            <div class="flex-grow">
                                <h4 class="font-bold text-gray-900">Check My Appointments</h4>
                                <p class="text-sm text-gray-600">View your full schedule and status updates.</p>
                            </div>
                            <div class="flex-shrink-0">
                                <a href="my_appointments.html" class="text-sm text-teal-600 hover:underline">View All</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
                        <h3 class="font-semibold text-gray-900">Recent Medical History</h3>
                        <a href="#" class="text-sm text-teal-600 hover:text-teal-700 font-medium">View All</a>
                    </div>
                    <div class="divide-y divide-gray-100">
                        <div class="p-6 hover:bg-gray-50 transition">
                            <div class="flex justify-between items-start">
                                <div><h4 class="font-medium text-gray-900">Annual Flu Vaccination</h4><p class="text-sm text-gray-500 mt-1">Administered by Nurse Josefa Reyes</p></div>
                                <span class="text-sm text-gray-400">Nov 10, 2025</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="appointment-modal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100] opacity-0 pointer-events-none">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-70"></div>
        <div class="modal-content bg-white rounded-xl shadow-2xl z-[110] w-11/12 md:max-w-xl mx-auto transform -translate-y-10 scale-95 border-t-4 border-teal-600">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold text-teal-800">Book an Appointment</h3>
                <button class="modal-close p-2 -mr-2 rounded-full hover:bg-gray-100"><svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="p-6">
                <form id="booking-form" action="#" method="POST" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="full-name-modal" value="Juan Dela Cruz" readonly class="mt-1 block w-full border border-gray-200 bg-gray-50 rounded-lg shadow-sm p-3 text-gray-600 cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Contact Number</label>
                            <input type="tel" value="0917-123-4567" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:border-teal-500 focus:ring-teal-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Service Needed</label>
                            <select id="service-modal" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 bg-white focus:border-teal-500 focus:ring-teal-500">
                                <option>Select a service</option><option>General Consultation</option><option>Vaccination</option><option>Prenatal Checkup</option><option>Dental Checkup</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Preferred Date</label>
                            <input type="date" id="date-modal" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:border-teal-500 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Preferred Time</label>
                            <select id="time-modal" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 bg-white focus:border-teal-500 focus:ring-teal-500">
                                <option value="">Select time</option><option value="08:00">8:00 AM - 9:00 AM</option><option value="09:00">9:00 AM - 10:00 AM</option><option value="10:00">10:00 AM - 11:00 AM</option><option value="13:00">1:00 PM - 2:00 PM</option><option value="14:00">2:00 PM - 3:00 PM</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="mt-6 w-full bg-gradient-to-r from-teal-600 to-teal-700 text-white px-8 py-3 rounded-full font-semibold hover:from-teal-700 hover:to-teal-600 transition duration-300 shadow-md">Confirm Booking</button>
                </form>
            </div>
        </div>
    </div>

    <script>
    const API_BASE_URL = 'http://localhost:8080';

    document.addEventListener('DOMContentLoaded', function() {
        setupHeaderDropdown();
        setupHidingHeader();
        setupMobileMenu();
        setupModals();
        setupBookingForm();
        loadUserProfile();
    });

    // --- A. LOAD PROFILE DATA ---
    async function loadUserProfile() {
        try {
            const response = await fetch(`${API_BASE_URL}/get-user-profile`);
            const data = await response.json();

            if (data.success) {
                const u = data.user;
                
                // IMPORTANT FIX: Ignore "undefined" or "undefined undefined" strings
                // If the DB sends bad data, we stick to the HTML placeholder "Juan Dela Cruz"
                if(u.name && u.name.trim() !== 'undefined undefined' && u.name !== 'undefined') {
                    document.getElementById('display-fullname').textContent = u.name;
                    document.getElementById('full-name-modal').value = u.name;
                    document.getElementById('mobile-name').textContent = u.name;
                }
                
                if(u.email && u.email !== 'undefined') {
                    document.getElementById('display-email').textContent = u.email;
                    document.getElementById('dropdown-email').textContent = u.email;
                    document.getElementById('mobile-email').textContent = u.email;
                }
                
                if(u.phone && u.phone !== 'undefined') {
                    document.getElementById('display-phone').textContent = u.phone;
                }
                
                if(u.address && u.address !== 'undefined') {
                    document.getElementById('display-address').textContent = u.address;
                }

                // Update Profile Picture
                if (u.profile_picture) {
                    const newSrc = `${API_BASE_URL}/${u.profile_picture}?t=${new Date().getTime()}`;
                    
                    if(document.getElementById('profile-display-img')) 
                        document.getElementById('profile-display-img').src = newSrc;
                    
                    if(document.getElementById('header-profile-img')) 
                        document.getElementById('header-profile-img').src = newSrc;
                        
                    if(document.getElementById('mobile-profile-img')) 
                        document.getElementById('mobile-profile-img').src = newSrc;
                }
            }
        } catch (error) {
            console.error("Error loading profile:", error);
        }
    }

    // --- B. BOOKING LOGIC ---
    function setupBookingForm() {
        const form = document.getElementById('booking-form');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const service = document.getElementById('service-modal').value;
                const dateVal = document.getElementById('date-modal').value;
                const time = document.getElementById('time-modal').value; 

                if(service.includes('Select') || !dateVal || !time) {
                    alert('Please fill in all fields.'); return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/book-appointment`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            patient_id: 1, 
                            appointment_date: dateVal + " " + time + ":00", 
                            reason: service 
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert("Appointment booked successfully!");
                        toggleModal(document.getElementById('appointment-modal'), false);
                        form.reset();
                    } else { alert("Error: " + result.error); }
                } catch(error) { console.error("Booking Error:", error); alert("Connection failed."); }
            });
        }
    }

    // --- C. UI HELPERS ---
    function logoutUser() {
        if(confirm("Sign out?")) { localStorage.clear(); window.location.href = "Homee.html"; }
    }

    function toggleModal(modal, show) {
        if (!modal) return;
        const content = modal.querySelector('.modal-content');
        const body = document.querySelector('body');
        if (show) {
            modal.classList.remove('opacity-0', 'pointer-events-none');
            content.classList.remove('-translate-y-10', 'scale-95');
            body.classList.add('modal-active');
        } else {
            modal.classList.add('opacity-0');
            content.classList.add('-translate-y-10', 'scale-95');
            setTimeout(() => { modal.classList.add('pointer-events-none'); body.classList.remove('modal-active'); }, 250);
        }
    }

    function setupModals() {
        const modal = document.getElementById('appointment-modal');
        if(modal) {
            document.querySelectorAll('.open-appointment-modal').forEach(btn => btn.addEventListener('click', (e) => { e.preventDefault(); toggleModal(modal, true); }));
            document.querySelectorAll('.modal-close, .modal-overlay').forEach(btn => btn.addEventListener('click', (e) => { e.preventDefault(); toggleModal(modal, false); }));
        }
    }

    function setupHeaderDropdown() {
        const btn = document.getElementById('user-menu-button');
        const menu = document.getElementById('user-dropdown-menu');
        if(btn && menu) {
            btn.addEventListener('click', (e) => { e.stopPropagation(); menu.classList.toggle('hidden'); menu.classList.toggle('opacity-0'); menu.classList.toggle('scale-95'); });
            window.addEventListener('click', (e) => { if(!btn.contains(e.target)) { menu.classList.add('hidden'); menu.classList.add('opacity-0'); } });
        }
    }

    function setupHidingHeader() {
        const header = document.getElementById('main-header');
        let lastScrollTop = 0;
        window.addEventListener('scroll', () => {
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            if (scrollTop > lastScrollTop && scrollTop > header.offsetHeight) { header.style.top = `-${header.offsetHeight}px`; } 
            else { header.style.top = '0'; }
            lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
        });
    }

    function setupMobileMenu() {
        document.getElementById('mobile-menu-toggle')?.addEventListener('click', () => { document.getElementById('mobile-menu').classList.toggle('hidden'); });
    }
    </script>
</body>
</html>